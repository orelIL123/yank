# סיכום שינויים - מערכת הרשאות ושמירת סשן

## תאריך: 28 בדצמבר 2025

## שינויים שבוצעו:

### 1. ✅ תיקון בעיית שמירת המשתמש

**הבעיה:** האפליקציה לא שמרה את המשתמש מחובר אחרי סגירה.

**הפתרון:**
- הסרנו את מערכת "זכור אותי" המיותרת
- Firebase Auth כבר שומר את הסשן אוטומטית ב-AsyncStorage
- המשתמש נשאר מחובר עד שהוא לוחץ "התנתק"
- פישטנו את הקוד ב-`LoginScreen.jsx`

**קבצים ששונו:**
- `native/src/screens/LoginScreen.jsx` - הוסרה לוגיקת "זכור אותי"

---

### 2. ✅ מערכת הרשאות למשתמשים

**תיאור:** יצירת מערכת הרשאות שמאפשרת לכל משתמש לנהל רק את התחומים שבאחריותו.

#### סוגי ההרשאות שנוצרו:

1. **prayers_manager** - אחראי על תפילות
   - יכולת להוסיף/לערוך/למחוק תפילות

2. **videos_manager** - אחראי על מבית רבנו
   - יכולת להוסיף/לערוך/למחוק סרטונים

3. **music_manager** - אחראי על ניגונים
   - יכולת להוסיף/לערוך/למחוק ניגונים

4. **books_manager** - אחראי על ספר תולדות אדם
   - יכולת להוסיף/לערוך/למחוק ספרים

5. **learning_manager** - אחראי על ספריית לימוד
   - יכולת להוסיף/לערוך/למחוק סרטונים קצרים וארוכים

6. **admin** - מנהל ראשי (גישה מלאה)

#### קבצים חדשים שנוצרו:

1. **`native/src/screens/ManagePermissionsScreen.jsx`**
   - מסך ניהול הרשאות למנהל
   - רשימת כל המשתמשים
   - אפשרות לתת/לקחת הרשאות

2. **`native/scripts/add-user-permissions.cjs`**
   - סקריפט להוספת הרשאות באמצעות שורת פקודה
   - שימוש: `node scripts/add-user-permissions.cjs email@example.com prayers_manager`

3. **`native/PERMISSIONS_GUIDE.md`**
   - מדריך מלא לשימוש במערכת ההרשאות

#### קבצים ששונו:

1. **`native/App.js`**
   - הוספת state לשמירת הרשאות המשתמש
   - העברת `userPermissions` לכל המסכים הרלוונטיים
   - הוספת import למסך ניהול הרשאות
   - הוספת route למסך ניהול הרשאות

2. **`native/src/screens/AdminScreen.jsx`**
   - הוספת כפתור למסך ניהול הרשאות
   - האייקון מופיע בפינה השמאלית העליונה

3. **`native/src/screens/PrayersScreen.jsx`**
   - שימוש ב-`canManagePrayers` במקום `isAdmin`
   - רק משתמשים עם הרשאת `prayers_manager` או מנהלים יכולים לנהל תפילות

4. **`native/src/screens/ShortLessonsScreen.jsx`**
   - שימוש ב-`canManageLearning` במקום `isAdmin`
   - רק משתמשים עם הרשאת `learning_manager` או מנהלים יכולים לנהל

5. **`native/src/screens/LongLessonsScreen.jsx`**
   - שימוש ב-`canManageLearning` במקום `isAdmin`
   - רק משתמשים עם הרשאת `learning_manager` או מנהלים יכולים לנהל

6. **`native/src/screens/MiBeitRabeinuScreen.jsx`**
   - שימוש ב-`canManageVideos` במקום `isAdmin`
   - רק משתמשים עם הרשאת `videos_manager` או מנהלים יכולים לנהל

7. **`native/src/utils/permissions.js`**
   - קובץ זה כבר היה קיים ומכיל את כל הפונקציות הנדרשות

---

## איך להשתמש במערכת החדשה?

### כמנהל ראשי:

1. **ניהול הרשאות דרך האפליקציה:**
   - היכנס כמנהל
   - לך לפאנל אדמין
   - לחץ על אייקון האנשים בפינה השמאלית העליונה
   - בחר משתמש והוסף לו הרשאות

2. **ניהול הרשאות דרך סקריפט:**
   ```bash
   cd native
   node scripts/add-user-permissions.cjs user@example.com prayers_manager,learning_manager
   ```

### כמשתמש עם הרשאות:

- אחרי שקיבלת הרשאות מהמנהל, תראה את הכפתורים לניהול בתחומים שבאחריותך
- לדוגמה: אם יש לך `prayers_manager`, תוכל להוסיף/לערוך/למחוק תפילות

---

## מבנה Firestore

```javascript
users/{userId}
{
  name: "שם המשתמש",
  email: "user@example.com",
  role: "user",  // או "admin"
  permissions: ["prayers_manager", "learning_manager"],  // מערך של הרשאות
  createdAt: "2024-01-01T00:00:00.000Z"
}
```

---

## בדיקות שכדאי לבצע:

1. ✅ וודא שהמשתמש נשאר מחובר אחרי סגירת האפליקציה
2. ✅ נסה לתת למשתמש רגיל הרשאת `prayers_manager` ובדוק שהוא רואה את כפתור ההוספה
3. ✅ וודא שמנהל רואה את כפתור ניהול ההרשאות בפאנל אדמין
4. ✅ נסה להוסיף תפילה עם משתמש שיש לו הרשאת `prayers_manager`
5. ✅ וודא שמשתמש בלי הרשאות לא רואה כפתורי ניהול

---

## הערות חשובות:

1. **Firebase Auth vs Supabase:**
   - המשתמשים והאימות נשארים ב-Firebase
   - הנתונים האחרים (תפילות, סרטונים וכו') ב-Supabase

2. **שמירת סשן:**
   - Firebase Auth שומר אוטומטית ב-AsyncStorage
   - אין צורך בלוגיקה נוספת

3. **הרשאות:**
   - מנהל (`role: "admin"`) יש לו גישה לכל
   - משתמש רגיל צריך הרשאות ספציפיות

---

## מורכבות היישום:

המורכבות **נמוכה-בינונית**:
- ✅ מערכת ההרשאות מבוססת על מבנה קיים
- ✅ הקוד ארגן היטב ומודולרי
- ✅ אין צורך בשינויים בסכמת הנתונים ב-Supabase
- ✅ רק הוספת שדה `permissions` ב-Firestore

---

## סיכום:

✅ **תיקנו** - האפליקציה עכשיו שומרת את המשתמש מחובר

✅ **הוספנו** - מערכת הרשאות מלאה עם 5 סוגי מנהלים

✅ **יצרנו** - מסך ניהול הרשאות למנהל ראשי

✅ **עדכנו** - כל המסכים הרלוונטיים להשתמש בהרשאות

המערכת מוכנה לשימוש! 🎉
